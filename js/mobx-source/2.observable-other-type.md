# JS mobx æºç è§£è¯»ï¼ˆäºŒï¼‰ï¼šéƒ½ observe object äº†ï¼Œå…¶ä»–ç±»å‹è¿˜ä¼šè¿œå—

æ–‡æœ¬æ˜¯ [mobx æºç è§£è¯»ç³»åˆ—](https://github.com/lawler61/blog#js-%E7%9B%B8%E5%85%B3) ç¬¬äºŒç¯‡

æœ¬ç³»åˆ—æ–‡ç« å…¨éƒ¨é‡‡ç”¨ mobx è¾ƒæ–°ç‰ˆæœ¬ï¼š[v5.13.0](https://github.com/lawler61/mobx)

[mobx æºç è§£è¯» issueï¼Œæ¬¢è¿è®¨è®º](https://github.com/lawler61/blog/issues?q=is%3Aissue+is%3Aopen+label%3A%22mobx+%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%22)

## æŠ€æœ¯å‰æ

åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›ä½ å¯¹ä»¥ä¸‹æŠ€æœ¯æœ‰æ‰€**äº†è§£æˆ–å®è·µ**ï¼Œä¸ç„¶å¯èƒ½ä¼šå½±å“ä½ å¯¹æœ¬æ–‡çš„ç†è§£

1. [ES6 è£…é¥°å™¨ï¼šdecorator](http://es6.ruanyifeng.com/#docs/decorator)

2. [ES6 ä»£ç†ï¼šproxy](http://es6.ruanyifeng.com/#docs/proxy)

3. [ES6 åå°„ï¼šreflect](http://es6.ruanyifeng.com/#docs/reflect)

4. [å®šä¹‰å¯¹è±¡å±æ€§ï¼šObject.defineProperty](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)

5. [å®ç°ç®€æ˜“ç‰ˆ è§‚å¯Ÿè€…æ¨¡å¼](https://github.com/lawler61/blog/issues/1)

6. [å®ç°ç®€æ˜“ç‰ˆ MVVMï¼ˆå¯é€‰ï¼‰](https://github.com/lawler61/blog/issues/5)

## å‡†å¤‡

1. ä¹‹å‰å‡ºçš„ç¬¬ä¸€ç¯‡æºç è§£è¯»ï¼Œæœ¬ä»¥ä¸ºåº”è¯¥æ²¡äººä¼šå…³æ³¨ï¼Œä½†è¿™å‘¨å±…ç„¶æ”¶åˆ°ç½‘å‹çš„å‚¬æ›´ï¼Œè¿˜æ˜¯å¾ˆæ„ŸåŠ¨ï¼Œå‡†å¤‡ç»§ç»­å†™ä¸‹å»

2. è¿™ç¯‡æ–‡ç« å’Œ [mobx æºç è§£è¯»ç³»åˆ—ï¼ˆä¸€ï¼‰](https://github.com/lawler61/blog/blob/master/js/mobx-source/1.observable-an-object.md)ï¼Œæœ‰å¾ˆå¼ºçš„å…³è”ï¼Œå¦‚æœä½ ç¬¬ä¸€ç¯‡æ–‡ç« å•ƒä¸‹æ¥äº†ï¼Œè¿™ç¯‡ç›¸å¯¹æ¥è¯´ä¼šæ˜¯ç¯‡æ°´æ–‡ï¼Œä½†ä½ æ²¡å•ƒä¸‹æ¥çš„è¯ï¼Œemm...ä¼°è®¡ä½ çœ‹çš„ä¼šå¾ˆè‰°éš¾

3. ä¸Šç¯‡æ–‡ç« æˆ‘ä»¬çŸ¥é“äº†ï¼š`ä¸‡èƒ½çš„è£…é¥°å™¨`ï¼Œ`é€’å½’åŠ«æŒ`ï¼Œ`adm ç®¡ç†å™¨`ï¼Œ`æ”¯æŒå’Œéœ² api`ï¼ŒåŠ«æŒ `array, Map, Set` å…¶å®åŒç†ï¼Œæ¥ä¸‹æ¥å°±ä¸€èµ·éªŒè¯ä¸‹æºç å§

## ä¸Šæºç 

### ä¸€ã€åŠ«æŒ array

1. å›åˆ° observableFactoriesï¼Œå®ƒéå†åç»™ observable æŒ‚ä¸Šå¤„ç†å„ç§ç±»å‹æ•°æ®çš„æ–¹æ³•

> å…ˆè°ƒç”¨ asCreateObservableOptions è®¡ç®— optionsï¼Œå½“ç„¶é»˜è®¤çš„å°±æ˜¯ defaultCreateObservableOptionsï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ deep å’Œ proxy åŠ«æŒ
>
> é‚£ getEnhancerFromOptions è·å–çš„å½“ç„¶æ˜¯ deppEnhancer

![observableFactories](./images/2/1.observableFactories.png)

2. çœ‹çœ‹ createObservableArray åšäº†ä»€ä¹ˆ

> é¦–å…ˆåˆ›å»º ObservableArrayAdministration ç®¡ç†å™¨
>
> æŒ‚ä¸Š hidden å±æ€§ $mobx æ–¹ä¾¿æš´éœ² api
>
> é€šè¿‡ arrayTrapsï¼ˆä¸€ä¼šè®²ï¼‰ç»™ adm.values æŒ‚ä¸Šè‡ªå·±å®ç°çš„ä¸€å¥— array çš„ api
>
> ç„¶åè°ƒç”¨ adm.spliceWithArray ç»™ adm.values åˆå§‹åŒ– initialValues å€¼ï¼ˆä½ å½“ç„¶èƒ½çŒœåˆ°æ˜¯åˆ©ç”¨ enhancer é€’å½’åŠ«æŒï¼‰

![createObservableArray](./images/2/2.createObservableArray.png)

3. çœ‹ä¸‹ ObservableArrayAdministration

> é‡Œé¢å›´ç»• values å±•å¼€ï¼Œå¹¶ä¸”æä¾›äº†å¾ˆå¤šæ“ä½œåœ¨ mobx å±‚é¢ä¸Šæ“ä½œæ•°ç»„çš„æ–¹æ³•
>
> åŒæ—¶ä¹Ÿä¸ºåæ–‡çš„ arrayExtensions æä¾›äº†å®ç°â€æ”¯æŒåŸç”Ÿæ•°ç»„ apiâ€œçš„æ”¯æŒ

![ObservableArrayAdministration](./images/2/3.ObservableArrayAdministration.png)

4. å…¶ä¸­æœ€é‡è¦çš„æ˜¯ spliceWithArrayï¼Œæˆå®ƒä¸ºâ€œä¸‡é‡‘æ²¹â€

> é‡Œé¢åšäº†å„ç§å…¼å®¹ï¼Œèƒ½å¤Ÿè¾¾åˆ°å¯¹æ•°ç»„çš„å¢åˆ æ”¹ï¼ŒåŒæ—¶è¿˜èƒ½åœ¨é€šçŸ¥å˜åŒ–æ¶ˆæ¯ï¼ˆhasInterceptorsï¼ŒnotifyArraySplice ç­‰ï¼Œè¿™ä¹Ÿæ˜¯é‡å†™ api çš„åŸå› ä¹‹ä¸€ï¼‰
>
> æ³¨æ„åˆ° newItemsï¼Œåˆå§‹åŒ–çš„æ—¶å€™å€¼å°±æ˜¯ initialValuesï¼Œç„¶åèµ° map é€šè¿‡ enhancer é€’å½’åŠ«æŒè¿”å›æ–°æ•°ç»„
>
> æ‰€ä»¥ adm.values çš„ item é¡¹ç±»å‹æ˜¯åœ¨ mobx å±‚é¢ä¸Šçš„å€¼ï¼Œå¦‚ï¼š
>
> [1, { a: 2 }, "c", [3], new Map(...)]ï¼Œä¼šè¿”å›ä¸ºï¼š
>
> [1, Observableobject, "c", Observablearray, Observablemap]
>
> åŠ«æŒåè°ƒç”¨ spliceItemsIntoValuesï¼Œå…¶æœ€ç»ˆè°ƒç”¨ values.splice

![spliceWithArray](./images/2/4.spliceWithArray.png)

5. æ¥ä¸‹æ¥å°±æ˜¯å¦‚ä½•ä½¿ç”¨â€œä¸‡ç²¾æ²¹â€ï¼šarrayExtensions

> é‡Œé¢é€šè¿‡ \$mobx æ‹¿åˆ° adm ä¸€é˜µä¹±ç”¨ï¼ˆå½“ç„¶å¯¹è±¡é‡Œä½¿ç”¨ this[\$mobx] è‚¯å®šæ˜¯ .call è¿‡å»çš„ï¼‰
>
> æ”¯æŒå®ŒåŸç”Ÿ array api åï¼Œç„¶åæä¾›äº†äº› mobx å±‚é¢çš„ apiï¼ˆtoJSï¼Œobserve ç­‰ï¼‰
>
> ç„¶åä¸æ”¹å˜æ•°ç»„æœ¬èº«çš„ apiï¼Œè®© adm.values å‡ºåœºå°±è¡Œäº†

![arrayExtensions](./images/2/5.arrayExtensions.png)

![other api](./images/2/6.other-api.png)

6. å®Œæˆäº†ä¸€æ•´å¥— apiï¼Œæœ€ç»ˆè‚¯å®šæ˜¯è¦æŒ‚åœ¨ values ä¸Šçš„ï¼ŒarrayTraps ç™»åœº

> å…¶å®å°±æ˜¯ descriptor å˜›ï¼Œæ²¡å•¥è¯´çš„ï¼Œä¸ä¹‹å‰çš„ proxy é…åˆå°±æŒ‚ä¸Šå»äº†å‘—

![arrayTraps](./images/2/7.arrayTraps.png)

7. æš´éœ² api

> å¿«ä¹å°±å®Œäº‹äº†

![array-api](./images/2/8.array-api.png)

### äºŒã€åŠ«æŒ Map

æ¥ä¸‹æ¥å°±æ²¡å•¥è¯´çš„äº†

1. è¿˜æ˜¯å›åˆ° observableFactoriesï¼Œè·å–å‚æ•°åï¼Œè¿”å›äº†ä¸€ä¸ª ObservableMap

![observableFactories](./images/2/9.observableFactories.png)

2. çœ‹çœ‹ ObservableMap

> åˆæ˜¯å›´ç»• this._data å±•å¼€ï¼Œé€šè¿‡ merge æ–¹æ³•èµ‹åˆå§‹å€¼
>
> ä½ é—­ç€çœ¼éƒ½èƒ½çŒœåˆ°ï¼šforeach éå† keyï¼Œæ‹¿åˆ° value ç„¶åç”¨ enhancer é€’å½’åŠ«æŒ
>
> ç„¶åæä¾›åŸç”Ÿ Map å’Œ mobx å±‚é¢ä¸Šçš„ api

![ObservableMap](./images/2/10.ObservableMap.png)

3. æš´éœ² apiï¼Œå›¾ç•¥

### ä¸‰ã€åŠ«æŒ Set

1. ä» observableFactories å‡ºå‘ï¼Œè¿”å› ObservableSet

> å›´ç»• this._data å±•å¼€ï¼Œé€šè¿‡ replace æ–¹æ³•èµ‹åˆå€¼
>
> æ¢æ±¤ä¸æ¢è¯ï¼šforeach + _data.add(new ObservableValue(value))
>
> ç„¶åå®ç°åŸç”Ÿ apiï¼Œæš´éœ²å‡ºå»ä½¿ç”¨

![ObservableSet](./images/2/11.ObservableSet.png)

### å››ã€åŠ«æŒ box

1. å¯¹äºåŸºæœ¬ç±»å‹ string, boolean, number å¯ä»¥ç”¨ box æ¥åŠ«æŒï¼Œå¯ä»¥æŒ‚ä¸Š get, set çš„æ–¹æ³•

2. å…¶å…·ä½“ä½¿ç”¨çš„æ˜¯ ObservableValueï¼Œä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ [mobx æºç è§£è¯»ç³»åˆ—ï¼ˆä¸€ï¼‰](https://github.com/lawler61/blog/blob/master/js/mobx-source/1.observable-an-object.md) ä¸­è®²çš„ ObservableObjectAdministration ç»´æŠ¤çš„ values çš„å€¼

3. åˆ°è¿™æ˜¯ä¸æ˜¯å¯¹ observableobject ç†è§£åˆåŠ æ·±äº†ä¸€æ­¥å‘¢

![ObservableValue](./images/2/12.ObservableValue.png)

![adm values](./images/2/13.adm-values.png)

## æœ€å

1. [å¸¦æ³¨é‡Šçš„ mobx æºç ](https://github.com/lawler61/mobx)

2. æ¬¢è¿åœ¨ [mobx æºç è§£è¯» issue](https://github.com/lawler61/blog/issues?q=is%3Aissue+is%3Aopen+label%3A%22mobx+%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%22) ä¸­è®¨è®º~

3. ä¸‹ç« å‰§é€ï¼š**è®²è®² mobx ä¸­çš„ä¾èµ–æ”¶é›†**

3. ç å­—ä¸æ˜“ï¼Œå–œæ¬¢çš„è®°å¾—ç‚¹ ğŸ’› å“¦
