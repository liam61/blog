# JS mobx æºç è§£è¯»ï¼ˆä¸‰ï¼‰ï¼šmobx ä¸­çš„ä¾èµ–æ”¶é›†ï¼šè®¢é˜…-å‘å¸ƒæ¨¡å¼

æ–‡æœ¬æ˜¯ [mobx æºç è§£è¯»ç³»åˆ—](https://github.com/lawler61/blog#js-%E7%9B%B8%E5%85%B3) ç¬¬ä¸‰ç¯‡

æœ¬ç³»åˆ—æ–‡ç« å…¨éƒ¨é‡‡ç”¨ mobx è¾ƒæ–°ç‰ˆæœ¬ï¼š[v5.13.0](https://github.com/lawler61/mobx)

[mobx æºç è§£è¯» issueï¼Œæ¬¢è¿è®¨è®º](https://github.com/lawler61/blog/issues?q=is%3Aissue+is%3Aopen+label%3A%22mobx+%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%22)

## æŠ€æœ¯å‰æ

åœ¨é˜…è¯»ä¹‹å‰ï¼Œå¸Œæœ›ä½ å¯¹ä»¥ä¸‹æŠ€æœ¯æœ‰æ‰€**äº†è§£æˆ–å®è·µ**ï¼Œä¸ç„¶å¯èƒ½ä¼šå½±å“ä½ å¯¹æœ¬æ–‡çš„ç†è§£

1. [ES6 è£…é¥°å™¨ï¼šdecorator](http://es6.ruanyifeng.com/#docs/decorator)

2. [ES6 ä»£ç†ï¼šproxy](http://es6.ruanyifeng.com/#docs/proxy)

3. [ES6 åå°„ï¼šreflect](http://es6.ruanyifeng.com/#docs/reflect)

4. [å®šä¹‰å¯¹è±¡å±æ€§ï¼šObject.defineProperty](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty)

5. [å®ç°ç®€æ˜“ç‰ˆ è§‚å¯Ÿè€…æ¨¡å¼](https://github.com/lawler61/blog/issues/1)

6. [å®ç°ç®€æ˜“ç‰ˆ MVVMï¼ˆå¯é€‰ï¼‰](https://github.com/lawler61/blog/issues/5)

## å‡†å¤‡

### ä¸€ã€ç›®çš„

1. æœ¬æ¥æƒ³ç›´æ¥ä» `autorun` è®²çš„ï¼Œå‘ç°æœ‰äº›å‘è¿˜æ˜¯è¦å…ˆå¡«ä¸Šï¼Œä¹‹å‰è§‰å¾— `ComputedValue` å’Œ`ObservableValue` ç›¸ä¼¼ï¼Œåé¢å‘ç°å¤§ä¸ç›¸åŒ

2. æ–‡æœ¬ä¸»è¦å›´ç»• `Derivation`ï¼Œ`ComputedValue`ï¼Œ`ObservableValue` è®²è®² `mobx` ä¸­çš„è®¢é˜…-å‘å¸ƒæ¨¡å¼

3. é¡ºä¾¿æ¢³ç†ä¸‹æŠŠä¸‰è€…å˜åŒ–è¿‡ç¨‹çš„`çŠ¶æ€æœº`ï¼Œä¸ºå…¶ä»– `autorun` åšé“ºå«

### äºŒã€æè¦

**æ¯ç‚¹éƒ½å¾ˆé‡è¦ï¼Œç‰¢è®°**

1. `mobx` ä¸­ç”± `Derivation`ï¼ˆ`reaction` ä¹Ÿæ˜¯å®ç°å®ƒï¼‰å……å½“è§‚å¯Ÿè€…ï¼Œå…¶ä¸­ `observing` ä»£è¡¨ä¾èµ–çš„å¯è§‚å¯Ÿå¯¹è±¡é›†åˆï¼Œ`dependenciesState` ä»£è¡¨è§‚å¯Ÿè€…çŠ¶æ€

![IDerivation](./images/3/1.IDerivation.png)

2. `ObservableValue` å……å½“å¯è§‚å¯Ÿå¯¹è±¡ï¼Œå…¶ä¸­ `observers` ä»£è¡¨ä¾èµ–å®ƒçš„è§‚å¯Ÿè€…é›†åˆï¼Œ`lowestObserverState` ä»£è¡¨å¯è§‚å¯Ÿå¯¹è±¡çš„çŠ¶æ€ï¼ˆå…¨æ–‡çš„ observable ä»£è¡¨ observableValueï¼ŒobservableObjectï¼ŒobservableArray...ï¼‰

![IObservable](./images/3/2.IObservable.png)

3. `ComputedValue` æœ‰ç‚¹ç‰¹æ®ŠåŒæ—¶å®ç°äº† `IDerivation` å’Œ `IObservable` æ¥å£ï¼Œæ‰€ä»¥å®ƒæ‹¥æœ‰ä¸Šè¿°ä¸¤ç‚¹çš„ç‰¹å¾ã€‚å› ä¸º`ComputedValue` å¯ä»¥è¢« `Derivation` ä¾èµ–ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥ä¾èµ– `ObservableValue`

```js
class Store {
  @observable num = 3;
  @computed get mixed() {
    return store.num + 1; // ä¾èµ– observableValue
  }
}

const store = new Store();
autorun(reaction => {
  console.log("autorun:", store.mixed); // è¢« Derivation ä¾èµ–
});
```

4. è¦æ³¨æ„çš„æ˜¯ `ComputedValue` ä½œä¸ºå¯è§‚å¯Ÿå¯¹è±¡å‘ `Derivation` æäº¤å˜åŒ–æ—¶ï¼Œè¦ä½¿ç”¨ `observing` å’Œ `lowestObserverState`ã€‚ç›¸åä½œä¸ºè§‚å¯Ÿè€…æ—¶ï¼Œç”¨ `observers` å’Œ `dependenciesState`

5. `DerivationState` çŠ¶æ€æœºï¼ŒçŠ¶æ€è¶Šé«˜è¡¨ç¤ºè¶Šä¸ç¨³å®šï¼ˆPOSSIBLY_STALEã€STALEï¼‰ï¼Œç›¸ååŒç†ï¼ˆUP_TO_DATEï¼‰

![IDerivationState](./images/3/3.IDerivationState.png)

## ä¸Šæºç 

### ä¸€ã€reaction å‡†å¤‡

1. autorun ä¼šè°ƒç”¨ reaction.schedule æ–¹æ³•å°†å…¶ push åˆ° globalState.pendingReactions

> å†è°ƒç”¨ runReactions éå† pendingReactions é€ä¸€æ”¶é›† reaction çš„ä¾èµ–

![schedule](./images/3/5.schedule.png)

2. runReactions ä¸­é€šè¿‡ while å–å‡º pendingReactions æ¥æ‰§è¡Œå®ƒä»¬çš„ runReaction æ–¹æ³•ï¼ˆä¸‹ç« ä¼šè¯´ï¼‰

> ç”¨ while æ˜¯å› ä¸ºåœ¨æ­¤è½®æ”¶é›†ä¾èµ–è¿‡ç¨‹ä¸­å¯èƒ½ä¼šæœ‰å…¶ä»–çš„ reaction åŠ å…¥
>
> æ–°å¢çš„ pendingReaction ä¹Ÿä¼šè°ƒç”¨ scheduleï¼Œä½†ä¼šåœ¨ runReactions çš„åˆ¤æ–­ä¸­å°†å…¶ return æ‰ï¼ˆå› ä¸º while èƒ½æ‹¿åˆ°æ–°å¢çš„ reactionï¼‰
>
> runReaction æœ€ç»ˆä¼šæ‰ç”¨ trackDerivedFunction å¼€å§‹ä¾èµ–æ”¶é›†

![runReactions](./images/3/6.runReactions.png)

### äºŒã€æ”¶é›†ä¾èµ–

1. æ”¶é›†ä¾èµ–æ ¸å¿ƒï¼štrackDerivedFunction

> å…ˆè°ƒç”¨ changeDependenciesStateTo0 æ–¹æ³•å°† derivation å’Œ observing ç½®ä¸ºç¨³å®šæ€ UP_TO_DATEï¼Œä¸»è¦æ˜¯æ–¹ä¾¿åç»­åˆ¤æ–­æ˜¯å¦å¤„åœ¨æ”¶é›†ä¾èµ–é˜¶æ®µï¼ˆä¸‹ç« ä¼šè®²ï¼‰
>
> trackingDerivation ä¸ºåœ¨å…¨å±€æ­£åœ¨æ”¶é›†ä¾èµ–çš„ derivationï¼Œåˆå§‹ä¸º null
>
> ä½¿ç”¨ newObserving ä¸´æ—¶å˜é‡å‚¨å­˜ä¾èµ–å’Œä¸ºåé¢çš„ç»‘å®šä¾èµ–åšå‡†å¤‡
>
> ç„¶åæ˜¯â€œåˆ‡åˆ†æ”¯â€ï¼Œè§ä¸‹ä»£ç ï¼Œ**è®°ä½è¿™ç§ç¥è¿¹çš„æ“ä½œ**ï¼Œåé¢ä¼šå¤šæ¬¡ç”¨åˆ°
>
> å…¶ä¸»è¦ç›®çš„æ˜¯ä¿å­˜æ­£åœ¨æ”¶é›†ä¾èµ–çš„ derivationï¼Œä»¥é˜² f.call(context) æ—¶é€’å½’è°ƒç”¨äº† trackDerivedFunctionï¼Œè€Œæ‰¾ä¸åˆ°ä¸Šä¸‹æ–‡
>
> èªæ˜çš„ä½ å¯èƒ½çŒœåˆ°äº†å…¶ä¸­åŒ…å« ComputedValue
>
> f.call(context) æ­£å¼æ‰§è¡Œ autorun ä¸­ä¼ å…¥çš„å‡½æ•°ï¼ŒnewObserving æ•°ç»„ä¹Ÿæ˜¯åœ¨è¿™ä¸€é˜¶æ®µå¡«å……çš„
>
> æœ€åæ˜¯ bindDependencies ç»‘å®šä¾èµ–

```js
const prevTracking = globalState.trackingDerivation
globalState.trackingDerivation = derivation;
doSomething(); // use globalState.trackingDerivation do something fun
globalState.trackingDerivation = prevTracking;
```

![trackDerivedFunction](./images/3/7.trackDerivedFunction.png)

![changeDependenciesStateTo0](./images/3/8.changeDependenciesStateTo0.png)

2. newObserving å‚¨å­˜ä¾èµ–

å›æƒ³ä¸‹æˆ‘ä»¬æ€ä¹ˆä½¿ç”¨ autorun çš„ï¼š

```js
const store = new Store();
autorun(reaction => {
  console.log("autorun:", store.mixed);
});
```

> å¦‚æœä½ å¯¹ observable æ•æ„Ÿçš„è¯ï¼Œè‚¯å®šä¼šååº”è¿‡æ¥ï¼šget ä»£ç†
>
> åœ¨ observableValue å’Œ computedValue çš„ get ä»£ç†é€šè¿‡è°ƒç”¨ reportObserved é€šçŸ¥ç»™ derivation
>
> observable çš„ reportObserved èƒ½åŠ›æ˜¯å› ä¸ºç»§æ‰¿ Atom

![get](./images/3/9.get.png)

![get](./images/3/10.get.png)

3. reportObserved å½“ç„¶æ˜¯è°ƒç”¨ globalState.trackingDerivation å’¯

![reportObserved](./images/3/11.reportObserved.png)

4. çœ‹ä¸Šé¢å›¾ï¼Œå†è¯´ä¸‹ computedValue çš„ get ä»£ç†

> é‡Œé¢è°ƒç”¨ trackAndCompute å°±æ˜¯åˆšè¯´åˆ°çš„â€œåˆ‡åˆ†æ”¯â€çš„æƒ…å†µ
>
> å¦‚æœ computedValue è¿˜æ²¡è¢« derivation ä¾èµ–ä¸”æ²¡è¢«è®¡ç®—è¿‡
>
> å°±é€’å½’ trackDerivedFunctionï¼Œä¼ å…¥ derivationï¼ˆcomputed å±æ€§ï¼‰å’Œ scopeï¼ˆstoreï¼‰
>
> å¼€å§‹ computedValue åˆ†æ”¯çš„ä¾èµ–æ”¶é›†ï¼Œæ”¶é›†å®Œåå†å›åˆ°åŸæ¥çš„ derivation

![trackAndCompute](./images/3/12.trackAndCompute.png)

5. å¦‚æœ trackAndCompute çš„å€¼æœ‰æ”¹å˜åˆ™è°ƒç”¨ propagateChangeConfirmed

> å°†è‡ªå·±ç½®ä¸ºâ€œé«˜çŠ¶â€ STALEï¼Œå¹¶é€šçŸ¥ observers è‡ªå·±æ”¹å˜äº†ï¼Œä½ ä»¬ä¹Ÿå»ä½œå‡ºç›¸åº”ååº”å§
>
> éœ€è¦æ³¨æ„ï¼Œå°±æ˜¯å¦‚æœ d.dependenciesState ä¸º UP_TO_DATEï¼Œåˆ™è¯´æ˜è¿™ä¸ª derivation æ­£åœ¨èµ° trackDerivedFunction
>
> éœ€è¦æ¢å¤ changeDependenciesStateTo0 çš„å·¥ä½œï¼Œå°† observable è¿”å›ç¨³å®šæ€

![propagateChangeConfirmed](./images/3/13.propagateChangeConfirmed.png)

6. æ—¢ç„¶è¯´åˆ°äº†æ”¹å˜ï¼Œé‚£ observableValue èµ° set ä»£ç†ä¹ŸåŒç†

> observableValue ä¸ä¼šé€’å½’ trackDerivedFunctionï¼Œç›´æ¥è°ƒç”¨ d.onBecomeStale å˜ä¸ºä¸ç¨³å®šæ€å³å¯

![observableValue](./images/3/14.observableValue.png)

### ä¸‰ã€ç»‘å®šä¾èµ–

f.call(context) æœŸé—´å®Œæˆäº† derivation å¯¹ observable ä¾èµ–çš„æ”¶é›†

1. å›åˆ° trackDerivedFunction çš„ bindDependencies

> é€šè¿‡ä¸‰ä¸ªå¾ªç¯å®Œæˆ observable å¯¹ derivation çš„æ”¶é›†å’Œæ„ŸçŸ¥
>
> â‘  éå† newObserving å°†æœªæ”¶é›†çš„ä¾èµ– diffValue ç½®ä¸º 1ï¼Œä¹‹å‰æ”¶é›†è¿‡äº†åˆ™å¿½ç•¥
>
> â‘¡ ç»™ observable è§£ç»‘ derivationï¼ˆçœ‹æ¸…æ¥šé¡ºåºå“¦ï¼‰ï¼Œå³ observable çš„æ”¹å˜ä¸éœ€è¦é€šçŸ¥ derivation äº†
>
> â‘¢ ç»™æ–°çš„ observable ç»‘å®š derivationï¼Œä»£è¡¨å®ƒä»¬çš„æ”¹å˜éœ€é€šçŸ¥ derivationï¼Œä¹‹å‰ç»‘è¿‡åˆ™å¿½ç•¥

![bindDependencies](./images/3/15.bindDependencies.png)

2. addObserver å¾ˆç®€å•

![addObserver](./images/3/16.addObserver.png)

## æœ€å

1. [å¸¦æ³¨é‡Šçš„ mobx æºç ](https://github.com/lawler61/mobx)

2. æ¬¢è¿åœ¨ [mobx æºç è§£è¯» issue](https://github.com/lawler61/blog/issues?q=is%3Aissue+is%3Aopen+label%3A%22mobx+%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%22) ä¸­è®¨è®º~

3. ä¸‹ç« å‰§é€ï¼š**è®²è®² mobx çš„ autorun æœºåˆ¶**

3. ç å­—ä¸æ˜“ï¼Œå–œæ¬¢çš„è®°å¾—ç‚¹ ğŸ’› å“¦
